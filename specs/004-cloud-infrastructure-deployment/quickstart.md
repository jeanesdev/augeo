# Quickstart: Cloud Infrastructure Setup

**Feature**: Cloud Infrastructure & Deployment
**Date**: 2025-10-27
**Audience**: DevOps engineers, infrastructure operators

## Overview

This guide walks through setting up the complete Azure cloud infrastructure for the Augeo Platform from scratch. Follow these steps to provision all required resources and deploy the application to a new environment.

## Prerequisites

### Required Tools

- **Azure CLI** (v2.50+): `curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash`
- **Git**: `sudo apt install git`
- **Docker**: `sudo apt install docker.io`
- **Node.js 22+**: Via nvm or package manager
- **Python 3.11+**: System package or pyenv
- **Poetry**: `curl -sSL https://install.python-poetry.org | python3 -`

### Azure Access

- Azure subscription with Contributor role
- Azure CLI authenticated: `az login`
- Permissions to create resource groups and resources

### GitHub Access

- GitHub repository access (jeanesdev/augeo-platform)
- Personal Access Token (PAT) with `repo` and `workflow` scopes

## Step 1: Provision Azure Infrastructure

### 1.1 Create Resource Group

```bash
# Set environment (dev, staging, or production)
ENVIRONMENT=dev
LOCATION=eastus

# Create resource group
az group create \
  --name augeo-${ENVIRONMENT}-rg \
  --location ${LOCATION} \
  --tags \
    Environment=${ENVIRONMENT} \
    Project=augeo-platform \
    Owner=operations
```

### 1.2 Deploy Infrastructure via Bicep

```bash
# Navigate to infrastructure directory
cd infrastructure/bicep

# Preview changes (what-if)
az deployment group what-if \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --template-file main.bicep \
  --parameters @parameters/${ENVIRONMENT}.bicepparam

# Deploy infrastructure
az deployment group create \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --template-file main.bicep \
  --parameters @parameters/${ENVIRONMENT}.bicepparam \
  --output json > deployment-output.json

# Extract outputs
DATABASE_URL=$(jq -r '.properties.outputs.databaseUrl.value' deployment-output.json)
REDIS_URL=$(jq -r '.properties.outputs.redisUrl.value' deployment-output.json)
```

**Estimated Time**: 15-20 minutes

### 1.3 Verify Resource Provisioning

```bash
# List all resources in resource group
az resource list \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --output table

# Verify App Service is running
az webapp show \
  --name augeo-${ENVIRONMENT}-api \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --query "state" --output tsv
# Expected output: Running
```

## Step 2: Configure Secrets in Key Vault

### 2.1 Generate Secrets

```bash
# Generate JWT secret (256-bit random hex)
JWT_SECRET=$(openssl rand -hex 32)

# Generate database password (if not auto-generated by Bicep)
DB_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
```

### 2.2 Store Secrets in Key Vault

```bash
KEY_VAULT_NAME=augeo-${ENVIRONMENT}-kv

# Store database URL
az keyvault secret set \
  --vault-name ${KEY_VAULT_NAME} \
  --name database-url \
  --value "postgresql://augeouser:${DB_PASSWORD}@augeo-${ENVIRONMENT}-postgres.postgres.database.azure.com/augeodb?sslmode=require"

# Store Redis URL
az keyvault secret set \
  --vault-name ${KEY_VAULT_NAME} \
  --name redis-url \
  --value "$(az redis show --name augeo-${ENVIRONMENT}-redis --resource-group augeo-${ENVIRONMENT}-rg --query 'hostName' -o tsv):6380?ssl=true"

# Store JWT secret
az keyvault secret set \
  --vault-name ${KEY_VAULT_NAME} \
  --name jwt-secret \
  --value "${JWT_SECRET}"
```

### 2.3 Grant App Service Access to Key Vault

```bash
# Get App Service managed identity principal ID
PRINCIPAL_ID=$(az webapp identity show \
  --name augeo-${ENVIRONMENT}-api \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --query principalId --output tsv)

# Grant Key Vault Secrets User role
az role assignment create \
  --assignee ${PRINCIPAL_ID} \
  --role "Key Vault Secrets User" \
  --scope $(az keyvault show --name ${KEY_VAULT_NAME} --query id --output tsv)
```

## Step 3: Configure Custom Domain (Production Only)

### 3.1 Purchase Domain

Option 1: Use Azure App Service Domain
```bash
az appservice domain create \
  --resource-group augeo-prod-rg \
  --hostname augeo.app \
  --contact-info @contact-info.json \
  --accept-terms
```

Option 2: Use external registrar (Namecheap, GoDaddy, etc.)
- Purchase domain manually
- Update nameservers to Azure DNS

### 3.2 Configure DNS Zone

```bash
# Create DNS zone (if not created by Bicep)
az network dns zone create \
  --resource-group augeo-prod-rg \
  --name augeo.app

# Get nameservers
az network dns zone show \
  --resource-group augeo-prod-rg \
  --name augeo.app \
  --query "nameServers" --output tsv

# Update domain registrar nameservers with the values above
```

### 3.3 Configure Custom Domains

```bash
# Add custom domain to App Service (backend)
az webapp config hostname add \
  --webapp-name augeo-prod-api \
  --resource-group augeo-prod-rg \
  --hostname api.augeo.app

# Add custom domain to Static Web App (frontend)
az staticwebapp hostname set \
  --name augeo-prod-admin \
  --resource-group augeo-prod-rg \
  --hostname admin.augeo.app

# SSL certificates will auto-provision within 10-15 minutes
```

### 3.4 Configure Email Domain (Azure Communication Services)

```bash
# Get domain verification token
VERIFICATION_TOKEN=$(az communication email domain show \
  --email-service-name augeo-prod-acs \
  --domain-name augeo.app \
  --resource-group augeo-prod-rg \
  --query "verificationRecords.domain.value" --output tsv)

# Add TXT record for domain verification
az network dns record-set txt add-record \
  --resource-group augeo-prod-rg \
  --zone-name augeo.app \
  --record-set-name @ \
  --value ${VERIFICATION_TOKEN}

# Verify domain (wait 5-10 minutes for DNS propagation)
az communication email domain show \
  --email-service-name augeo-prod-acs \
  --domain-name augeo.app \
  --resource-group augeo-prod-rg \
  --query "domainManagement"
# Expected: "AzureManaged" or "CustomerManaged"
```

## Step 4: Set Up CI/CD Pipeline

### 4.1 Configure GitHub Repository Secrets

```bash
# Create Azure service principal for GitHub Actions
az ad sp create-for-rbac \
  --name "github-actions-augeo-${ENVIRONMENT}" \
  --role contributor \
  --scopes /subscriptions/${AZURE_SUBSCRIPTION_ID}/resourceGroups/augeo-${ENVIRONMENT}-rg \
  --sdk-auth > azure-credentials.json

# Output AZURE_CREDENTIALS JSON
cat azure-credentials.json
```

Add the following secrets to GitHub repository (Settings → Secrets → Actions):

- `AZURE_CREDENTIALS_DEV` - Azure service principal credentials (dev)
- `AZURE_CREDENTIALS_STAGING` - Azure service principal credentials (staging)
- `AZURE_CREDENTIALS_PROD` - Azure service principal credentials (production)
- `AZURE_SUBSCRIPTION_ID` - Azure subscription ID
- `ACR_USERNAME` - Azure Container Registry username (if using ACR)
- `ACR_PASSWORD` - Azure Container Registry password (if using ACR)

### 4.2 Configure GitHub Environments

Create GitHub environments with protection rules:

**Development**:
- No protection rules
- Auto-deploy on merge to `main`

**Staging**:
- No protection rules
- Auto-deploy after dev deployment succeeds

**Production**:
- Required reviewers: ops team
- Wait timer: 5 minutes (review window)
- Manual approval required before deployment

### 4.3 Trigger Initial Deployment

```bash
# Push code to trigger CI/CD
git checkout main
git pull origin main

# GitHub Actions will automatically:
# 1. Run tests
# 2. Build Docker images
# 3. Deploy to dev environment
# 4. Deploy to staging (if tests pass)
# 5. Wait for approval for production
```

## Step 5: Initialize Database

### 5.1 Run Database Migrations

```bash
# SSH into App Service container (or run locally with DATABASE_URL)
cd backend

# Run Alembic migrations
poetry run alembic upgrade head

# Verify tables created
poetry run python -c "
from app.core.database import engine
from sqlalchemy import inspect
inspector = inspect(engine)
print(inspector.get_table_names())
"
```

### 5.2 Seed Initial Data (Optional)

```bash
# Create superadmin user
poetry run python scripts/create_superadmin.py \
  --email admin@augeo.app \
  --password <secure-password> \
  --name "Admin User"

# Seed test data (dev/staging only)
poetry run python scripts/seed_test_data.py
```

## Step 6: Configure Monitoring

### 6.1 Set Up Alert Rules

```bash
# Create action group for notifications
az monitor action-group create \
  --name augeo-${ENVIRONMENT}-alerts \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --short-name augeo-alert \
  --email-receiver \
    name=ops-team \
    email-address=ops@augeo.app

# Create metric alert for high error rate
az monitor metrics alert create \
  --name high-error-rate \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --scopes $(az webapp show --name augeo-${ENVIRONMENT}-api --resource-group augeo-${ENVIRONMENT}-rg --query id -o tsv) \
  --condition "avg requests/failed > 5" \
  --window-size 5m \
  --evaluation-frequency 1m \
  --action augeo-${ENVIRONMENT}-alerts
```

### 6.2 Create Monitoring Dashboard

```bash
# Import pre-built dashboard
az portal dashboard import \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --input-path dashboards/system-health.json
```

Access dashboards:
- Azure Portal → Dashboards
- Application Insights → Workbooks → System Health

## Step 7: Verify Deployment

### 7.1 Health Check Endpoints

```bash
# Check backend health
curl https://api.augeo.app/health
# Expected: {"status": "healthy", "timestamp": "..."}

# Check detailed health
curl https://api.augeo.app/health/detailed
# Expected: {"status": "healthy", "database": "connected", "redis": "connected", ...}

# Check frontend
curl https://admin.augeo.app
# Expected: HTML page with React app
```

### 7.2 Test Application Flow

1. Open `https://admin.augeo.app` in browser
2. Register new user account
3. Check email delivery (verify inbox)
4. Log in to admin panel
5. Create test event
6. Verify all features work

### 7.3 Monitor Logs

```bash
# Stream application logs
az webapp log tail \
  --name augeo-${ENVIRONMENT}-api \
  --resource-group augeo-${ENVIRONMENT}-rg

# Query Application Insights logs
az monitor app-insights query \
  --app augeo-${ENVIRONMENT}-appinsights \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --analytics-query "requests | where timestamp > ago(1h) | summarize count() by resultCode"
```

## Step 8: Post-Deployment Checklist

- [ ] All Azure resources provisioned successfully
- [ ] App Service and Static Web App are running
- [ ] Database migrations completed
- [ ] Secrets stored in Key Vault
- [ ] Managed identity accessing Key Vault correctly
- [ ] Custom domain configured with SSL certificates
- [ ] Email domain verified and DNS records configured
- [ ] CI/CD pipeline running successfully
- [ ] Health check endpoints returning 200 OK
- [ ] Application Insights receiving telemetry
- [ ] Alert rules configured and action groups notified
- [ ] Monitoring dashboard accessible
- [ ] Test user can register and log in
- [ ] Email delivery working (check inbox)
- [ ] Cost budgets and alerts configured

## Troubleshooting

### App Service Won't Start

```bash
# Check logs
az webapp log tail --name augeo-${ENVIRONMENT}-api --resource-group augeo-${ENVIRONMENT}-rg

# Common issues:
# - Key Vault access denied → verify managed identity has role assignment
# - Database connection failed → check firewall rules allow App Service subnet
# - Missing environment variables → verify App Service configuration
```

### Email Not Sending

```bash
# Verify domain verification status
az communication email domain show \
  --email-service-name augeo-${ENVIRONMENT}-acs \
  --domain-name augeo.app \
  --resource-group augeo-${ENVIRONMENT}-rg

# Check DNS records
dig TXT augeo.app
dig TXT _dmarc.augeo.app
dig CNAME selector1._domainkey.augeo.app
```

### Database Connection Issues

```bash
# Test database connectivity from App Service
az webapp ssh --name augeo-${ENVIRONMENT}-api --resource-group augeo-${ENVIRONMENT}-rg

# Inside container:
apt update && apt install postgresql-client -y
psql $DATABASE_URL -c "SELECT version();"
```

### High Costs

```bash
# Review cost analysis
az consumption usage list \
  --start-date $(date -d '30 days ago' +%Y-%m-%d) \
  --end-date $(date +%Y-%m-%d) \
  --output table

# Common cost optimizations:
# - Shut down dev/staging overnight
# - Reduce Application Insights sampling
# - Use Azure Reservations for 1-year commitment
```

## Rollback Procedures

### Rollback Application Deployment

```bash
# Swap deployment slots (if blue-green deployment)
az webapp deployment slot swap \
  --name augeo-${ENVIRONMENT}-api \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --slot staging \
  --target-slot production

# Or redeploy previous Docker image
PREVIOUS_TAG=v1.2.3
az webapp config container set \
  --name augeo-${ENVIRONMENT}-api \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --docker-custom-image-name ghcr.io/jeanesdev/augeo-backend:${PREVIOUS_TAG}
```

### Rollback Database Migration

```bash
# Downgrade Alembic migration
cd backend
poetry run alembic downgrade -1

# Or restore from backup
az postgres flexible-server restore \
  --resource-group augeo-${ENVIRONMENT}-rg \
  --name augeo-${ENVIRONMENT}-postgres \
  --source-server augeo-${ENVIRONMENT}-postgres \
  --restore-time "2025-10-27T10:00:00Z"
```

## Next Steps

- Set up quarterly disaster recovery drills
- Implement cost optimization strategies
- Configure multi-region failover (Phase 2)
- Add read replicas for database scaling (Phase 2)
- Integrate with PagerDuty for on-call alerts

## Additional Resources

- [Azure App Service Documentation](https://docs.microsoft.com/azure/app-service/)
- [Azure Bicep Documentation](https://docs.microsoft.com/azure/azure-resource-manager/bicep/)
- [Application Insights Documentation](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview)
- [PostgreSQL on Azure Documentation](https://docs.microsoft.com/azure/postgresql/)

---

**Document Version**: 1.0
**Last Updated**: 2025-10-27
**Maintained By**: Operations Team
